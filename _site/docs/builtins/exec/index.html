<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>exec() - 代码执行函数 - Python知识体系文档</title>
  <meta name="description" content="执行字符串形式的Python代码">

  <!-- SEO标签 -->
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>exec() - 代码执行函数 | Python知识体系文档</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="exec() - 代码执行函数" />
<meta name="author" content="Python文档工程师" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="执行字符串形式的Python代码" />
<meta property="og:description" content="执行字符串形式的Python代码" />
<link rel="canonical" href="http://0.0.0.0:4000/PythonModelBook/docs/builtins/exec/" />
<meta property="og:url" content="http://0.0.0.0:4000/PythonModelBook/docs/builtins/exec/" />
<meta property="og:site_name" content="Python知识体系文档" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-01-15T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="exec() - 代码执行函数" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Python文档工程师"},"dateModified":"2024-01-15T00:00:00+08:00","datePublished":"2024-01-15T00:00:00+08:00","description":"执行字符串形式的Python代码","headline":"exec() - 代码执行函数","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/PythonModelBook/docs/builtins/exec/"},"url":"http://0.0.0.0:4000/PythonModelBook/docs/builtins/exec/"}</script>
<!-- End Jekyll SEO tag -->


  <!-- 样式文件 -->
  <link rel="stylesheet" href="/PythonModelBook/assets/css/main.css">
  <link rel="stylesheet" href="/PythonModelBook/assets/css/light-theme.css">
  <link rel="stylesheet" href="/PythonModelBook/assets/css/dark-theme.css">

  <!-- 字体 -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- 图标 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- 搜索功能 -->
  <script src="https://unpkg.com/lunr/lunr.js"></script>
</head>

<body>
  <!-- 导航栏 -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <a href="/PythonModelBook/" class="brand-link">
          <i class="fab fa-python"></i>
          <span>Python知识体系文档</span>
        </a>
      </div>

      <!-- 搜索框 -->
      <div class="nav-search">
        <div class="search-container">
          <input type="text" id="search-input" placeholder="搜索文档..." class="search-input">
          <i class="fas fa-search search-icon"></i>
          <div id="search-results" class="search-results"></div>
        </div>
      </div>

      <!-- 导航菜单 -->
      <div class="nav-menu">
        <a href="/PythonModelBook/" class="nav-link">首页</a>
        <a href="/PythonModelBook/docs/" class="nav-link">文档</a>
        <a href="/PythonModelBook/about/" class="nav-link">关于</a>
        <button id="theme-toggle" class="theme-toggle" title="切换主题">
          <i class="fas fa-moon"></i>
        </button>
      </div>

      <!-- 移动端菜单按钮 -->
      <button class="mobile-menu-btn" id="mobile-menu-btn">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </nav>

  <!-- 主要内容 -->
  <main class="main-content">
    <div class="doc-container">
  <!-- 文档内容区域 -->
  <main class="doc-content">
    <article class="doc-article">
      <!-- 文档头部信息 -->
      <header class="doc-header">
        <h1 class="doc-title">exec() - 代码执行函数</h1>
        
        
        <p class="doc-description">执行字符串形式的Python代码</p>
        
        
        <div class="doc-meta">
          
          <span class="doc-category">分类: builtins</span>
          
          
          
          <span class="doc-difficulty">难度: 高级</span>
          
          
          
          <span class="doc-updated">更新: 2024-01-15</span>
          
        </div>
        
        
        <div class="doc-tags">
          
          <span class="tag">代码执行</span>
          
          <span class="tag">动态执行</span>
          
          <span class="tag">语句执行</span>
          
          <span class="tag">安全风险</span>
          
        </div>
        
      </header>
      
      <!-- 文档正文 -->
      <div class="doc-body">
        <h1 id="exec---代码执行函数">exec() - 代码执行函数</h1>

<h2 id="-概述">📝 概述</h2>

<p><code class="language-plaintext highlighter-rouge">exec()</code> 是Python中的内置函数，用于执行字符串形式的Python代码。与 <code class="language-plaintext highlighter-rouge">eval()</code> 不同，<code class="language-plaintext highlighter-rouge">exec()</code> 可以执行完整的Python语句，包括赋值、循环、函数定义、类定义等。这个函数提供了强大的动态代码执行能力，但同时也带来了严重的安全风险。</p>

<h2 id="️-安全警告">⚠️ 安全警告</h2>

<p><strong>exec()函数存在极高的安全风险！</strong></p>
<ul>
  <li>永远不要对不可信的输入使用exec()</li>
  <li>恶意代码可能完全控制系统</li>
  <li>在生产环境中使用时必须进行严格的安全控制</li>
  <li>考虑使用更安全的替代方案</li>
</ul>

<h2 id="-学习目标">🎯 学习目标</h2>

<ul>
  <li>掌握exec()函数的基本用法和语法</li>
  <li>理解exec()与eval()的区别</li>
  <li>学会安全地使用exec()函数</li>
  <li>了解exec()的应用场景和限制</li>
  <li>掌握动态代码生成和执行技术</li>
</ul>

<h2 id="-前置知识">📋 前置知识</h2>

<ul>
  <li>Python基本语法</li>
  <li>表达式和语句的区别</li>
  <li>作用域和命名空间的概念</li>
  <li>异常处理的基本知识</li>
  <li>安全编程的基本概念</li>
  <li>面向对象编程基础</li>
</ul>

<h2 id="-详细内容">🔍 详细内容</h2>

<h3 id="基本概念">基本概念</h3>

<p><code class="language-plaintext highlighter-rouge">exec()</code> 函数接受一个字符串参数，将其作为Python代码进行执行。它可以执行任何有效的Python语句，包括：</p>
<ul>
  <li>赋值语句</li>
  <li>控制流语句（if、for、while等）</li>
  <li>函数定义</li>
  <li>类定义</li>
  <li>导入语句</li>
  <li>其他复杂的Python代码</li>
</ul>

<h3 id="语法格式">语法格式</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">exec</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="参数说明">参数说明</h3>

<table>
  <thead>
    <tr>
      <th>参数名</th>
      <th>类型</th>
      <th>必需</th>
      <th>默认值</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>object</td>
      <td>字符串或代码对象</td>
      <td>是</td>
      <td>无</td>
      <td>要执行的Python代码</td>
    </tr>
    <tr>
      <td>globals</td>
      <td>字典</td>
      <td>否</td>
      <td>None</td>
      <td>全局命名空间</td>
    </tr>
    <tr>
      <td>locals</td>
      <td>字典</td>
      <td>否</td>
      <td>None</td>
      <td>局部命名空间</td>
    </tr>
  </tbody>
</table>

<h3 id="返回值">返回值</h3>

<ul>
  <li><strong>类型</strong>: None</li>
  <li><strong>说明</strong>: exec()总是返回None，但执行的代码可能会修改命名空间</li>
</ul>

<h2 id="-代码示例">💡 代码示例</h2>

<h3 id="基本用法">基本用法</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 基本语句执行
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">基本语句执行:</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 简单赋值
</span><span class="nf">exec</span><span class="p">(</span><span class="sh">"</span><span class="s">x = 10</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">x = </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 10
</span>
<span class="c1"># 多行代码
</span><span class="n">code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
y = 20
z = x + y
print(f</span><span class="sh">'</span><span class="s">x + y = {z}</span><span class="sh">'</span><span class="s">)
</span><span class="sh">"""</span>
<span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

<span class="c1"># 控制流语句
</span><span class="n">loop_code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
for i in range(3):
    print(f</span><span class="sh">'</span><span class="s">循环 {i}</span><span class="sh">'</span><span class="s">)
</span><span class="sh">"""</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">控制流执行:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">exec</span><span class="p">(</span><span class="n">loop_code</span><span class="p">)</span>

<span class="c1"># 条件语句
</span><span class="n">condition_code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
if x &gt; 5:
    print(</span><span class="sh">'</span><span class="s">x 大于 5</span><span class="sh">'</span><span class="s">)
else:
    print(</span><span class="sh">'</span><span class="s">x 不大于 5</span><span class="sh">'</span><span class="s">)
</span><span class="sh">"""</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">条件语句执行:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">exec</span><span class="p">(</span><span class="n">condition_code</span><span class="p">)</span>

<span class="c1"># 函数定义和调用
</span><span class="n">function_code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
def greet(name):
    return f</span><span class="sh">'</span><span class="s">Hello, {name}!</span><span class="sh">'</span><span class="s">

message = greet(</span><span class="sh">'</span><span class="s">Python</span><span class="sh">'</span><span class="s">)
print(message)
</span><span class="sh">"""</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">函数定义执行:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">exec</span><span class="p">(</span><span class="n">function_code</span><span class="p">)</span>

<span class="c1"># 类定义
</span><span class="n">class_code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
class Person:
    def __init__(self, name, age):
        self.name = name
        self.age = age
    
    def introduce(self):
        return f</span><span class="sh">'</span><span class="s">我是{self.name}，{self.age}岁</span><span class="sh">'</span><span class="s">

person = Person(</span><span class="sh">'</span><span class="s">张三</span><span class="sh">'</span><span class="s">, 25)
print(person.introduce())
</span><span class="sh">"""</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">类定义执行:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">exec</span><span class="p">(</span><span class="n">class_code</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="使用自定义命名空间">使用自定义命名空间</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 自定义命名空间示例
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">自定义命名空间示例:</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 创建隔离的全局命名空间
</span><span class="n">custom_globals</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">print</span><span class="sh">'</span><span class="p">:</span> <span class="k">print</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">len</span><span class="sh">'</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">range</span><span class="sh">'</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">str</span><span class="sh">'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">int</span><span class="sh">'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">float</span><span class="sh">'</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">},</span>
    <span class="sh">'</span><span class="s">math_pi</span><span class="sh">'</span><span class="p">:</span> <span class="mf">3.14159</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">math_e</span><span class="sh">'</span><span class="p">:</span> <span class="mf">2.71828</span>
<span class="p">}</span>

<span class="c1"># 创建局部命名空间
</span><span class="n">custom_locals</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># 在自定义命名空间中执行代码
</span><span class="n">code_with_namespace</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
# 定义一些变量
radius = 5
area = math_pi * radius ** 2

# 定义函数
def calculate_circle_area(r):
    return math_pi * r ** 2

def calculate_volume(r, h):
    base_area = calculate_circle_area(r)
    return base_area * h

# 计算结果
results = {
    </span><span class="sh">'</span><span class="s">area</span><span class="sh">'</span><span class="s">: area,
    </span><span class="sh">'</span><span class="s">volume</span><span class="sh">'</span><span class="s">: calculate_volume(3, 10)
}

print(f</span><span class="sh">'</span><span class="s">圆面积: {area}</span><span class="sh">'</span><span class="s">)
print(f</span><span class="sh">'</span><span class="s">圆柱体积: {results[</span><span class="sh">"</span><span class="s">volume</span><span class="sh">"</span><span class="s">]}</span><span class="sh">'</span><span class="s">)
</span><span class="sh">"""</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">在自定义命名空间中执行:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">exec</span><span class="p">(</span><span class="n">code_with_namespace</span><span class="p">,</span> <span class="n">custom_globals</span><span class="p">,</span> <span class="n">custom_locals</span><span class="p">)</span>

<span class="c1"># 查看执行后的局部变量
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">执行后的局部变量:</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">custom_locals</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">.</span><span class="nf">startswith</span><span class="p">(</span><span class="sh">'</span><span class="s">__</span><span class="sh">'</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 尝试访问被限制的功能
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">安全性测试:</span><span class="sh">"</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">restricted_code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
import os
os.system(</span><span class="sh">'</span><span class="s">echo </span><span class="sh">"</span><span class="s">这不应该执行</span><span class="sh">"'</span><span class="s">)
</span><span class="sh">"""</span>
    <span class="nf">exec</span><span class="p">(</span><span class="n">restricted_code</span><span class="p">,</span> <span class="n">custom_globals</span><span class="p">,</span> <span class="p">{})</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">访问受限功能失败（预期）: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 动态变量访问
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">动态变量访问:</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 从局部命名空间获取函数
</span><span class="k">if</span> <span class="sh">'</span><span class="s">calculate_circle_area</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">custom_locals</span><span class="p">:</span>
    <span class="n">calc_func</span> <span class="o">=</span> <span class="n">custom_locals</span><span class="p">[</span><span class="sh">'</span><span class="s">calculate_circle_area</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">calc_func</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">动态调用函数结果: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="动态代码生成">动态代码生成</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 动态代码生成示例
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">动态代码生成示例:</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 代码生成器类
</span><span class="k">class</span> <span class="nc">CodeGenerator</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">动态代码生成器</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">indent_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">add_line</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">添加代码行</span><span class="sh">"""</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="sh">'</span><span class="s">    </span><span class="sh">'</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">indent_level</span>
        <span class="n">self</span><span class="p">.</span><span class="n">code_lines</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">增加缩进</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">indent_level</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">dedent</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">减少缩进</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">indent_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">indent_level</span> <span class="o">-=</span> <span class="mi">1</span>
    
    <span class="k">def</span> <span class="nf">get_code</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">获取生成的代码</span><span class="sh">"""</span>
        <span class="k">return</span> <span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">code_lines</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">清空代码</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">code_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">indent_level</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># 生成数学函数
</span><span class="k">def</span> <span class="nf">generate_math_function</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">operations</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">生成数学函数</span><span class="sh">"""</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="nc">CodeGenerator</span><span class="p">()</span>
    
    <span class="c1"># 函数定义
</span>    <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">def </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s">(x):</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">indent</span><span class="p">()</span>
    
    <span class="c1"># 添加操作
</span>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">operations</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">result = x </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">result = result </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 返回结果
</span>    <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sh">"</span><span class="s">return result</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">generator</span><span class="p">.</span><span class="nf">get_code</span><span class="p">()</span>

<span class="c1"># 生成并执行数学函数
</span><span class="n">math_operations</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">+ 10</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">* 2</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">- 5</span><span class="sh">'</span><span class="p">]</span>
<span class="n">math_code</span> <span class="o">=</span> <span class="nf">generate_math_function</span><span class="p">(</span><span class="sh">'</span><span class="s">custom_math</span><span class="sh">'</span><span class="p">,</span> <span class="n">math_operations</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">生成的数学函数代码:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">math_code</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">执行生成的函数:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">exec</span><span class="p">(</span><span class="n">math_code</span><span class="p">)</span>

<span class="c1"># 测试生成的函数
</span><span class="n">test_values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>
<span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">test_values</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">custom_math</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">custom_math(</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s">) = </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 生成类定义
</span><span class="k">def</span> <span class="nf">generate_data_class</span><span class="p">(</span><span class="n">class_name</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">生成数据类</span><span class="sh">"""</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="nc">CodeGenerator</span><span class="p">()</span>
    
    <span class="c1"># 类定义
</span>    <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">class </span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s">:</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">indent</span><span class="p">()</span>
    
    <span class="c1"># __init__ 方法
</span>    <span class="n">params</span> <span class="o">=</span> <span class="sh">'</span><span class="s">, </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">def __init__(self, </span><span class="si">{</span><span class="n">params</span><span class="si">}</span><span class="s">):</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">indent</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">self.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s"> = </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">generator</span><span class="p">.</span><span class="nf">dedent</span><span class="p">()</span>
    
    <span class="c1"># __str__ 方法
</span>    <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sh">"</span><span class="s">def __str__(self):</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">indent</span><span class="p">()</span>
    
    <span class="n">field_strs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="sh">"'</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s">: }</span><span class="sh">'"</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">{field}</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="s">self.</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
    <span class="n">fields_format</span> <span class="o">=</span> <span class="sh">'</span><span class="s"> + </span><span class="sh">"</span><span class="s">, </span><span class="sh">"</span><span class="s"> + </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">field_strs</span><span class="p">)</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">return f</span><span class="sh">'</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s">(</span><span class="sh">'</span><span class="s"> + </span><span class="si">{</span><span class="n">fields_format</span><span class="si">}</span><span class="s"> + </span><span class="sh">'</span><span class="s">)</span><span class="sh">'"</span><span class="p">)</span>
    
    <span class="n">generator</span><span class="p">.</span><span class="nf">dedent</span><span class="p">()</span>
    
    <span class="c1"># __repr__ 方法
</span>    <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sh">"</span><span class="s">def __repr__(self):</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">indent</span><span class="p">()</span>
    <span class="n">generator</span><span class="p">.</span><span class="nf">add_line</span><span class="p">(</span><span class="sh">"</span><span class="s">return self.__str__()</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">generator</span><span class="p">.</span><span class="nf">get_code</span><span class="p">()</span>

<span class="c1"># 生成并执行数据类
</span><span class="n">data_fields</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">age</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">city</span><span class="sh">'</span><span class="p">]</span>
<span class="n">data_class_code</span> <span class="o">=</span> <span class="nf">generate_data_class</span><span class="p">(</span><span class="sh">'</span><span class="s">Person</span><span class="sh">'</span><span class="p">,</span> <span class="n">data_fields</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">生成的数据类代码:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">data_class_code</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">执行生成的类:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">exec</span><span class="p">(</span><span class="n">data_class_code</span><span class="p">)</span>

<span class="c1"># 测试生成的类
</span><span class="n">person1</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">'</span><span class="s">Alice</span><span class="sh">'</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="sh">'</span><span class="s">Beijing</span><span class="sh">'</span><span class="p">)</span>
<span class="n">person2</span> <span class="o">=</span> <span class="nc">Person</span><span class="p">(</span><span class="sh">'</span><span class="s">Bob</span><span class="sh">'</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="sh">'</span><span class="s">Shanghai</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">person1: </span><span class="si">{</span><span class="n">person1</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">person2: </span><span class="si">{</span><span class="n">person2</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="配置驱动的代码执行">配置驱动的代码执行</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span>

<span class="c1"># 配置驱动的代码执行系统
</span><span class="k">class</span> <span class="nc">ConfigDrivenExecutor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">配置驱动的代码执行器</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">safe_builtins</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">print</span><span class="sh">'</span><span class="p">:</span> <span class="k">print</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">len</span><span class="sh">'</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">range</span><span class="sh">'</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">enumerate</span><span class="sh">'</span><span class="p">:</span> <span class="nb">enumerate</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">zip</span><span class="sh">'</span><span class="p">:</span> <span class="nb">zip</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">map</span><span class="sh">'</span><span class="p">:</span> <span class="nb">map</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">filter</span><span class="sh">'</span><span class="p">:</span> <span class="nb">filter</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">:</span> <span class="nb">sum</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">:</span> <span class="nb">max</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">abs</span><span class="sh">'</span><span class="p">:</span> <span class="nb">abs</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">round</span><span class="sh">'</span><span class="p">:</span> <span class="nb">round</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">int</span><span class="sh">'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">float</span><span class="sh">'</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">str</span><span class="sh">'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">bool</span><span class="sh">'</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">list</span><span class="sh">'</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">tuple</span><span class="sh">'</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">dict</span><span class="sh">'</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">set</span><span class="sh">'</span><span class="p">:</span> <span class="nb">set</span>
        <span class="p">}</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">execution_context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">safe_builtins</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">:</span> <span class="p">{},</span>
            <span class="sh">'</span><span class="s">results</span><span class="sh">'</span><span class="p">:</span> <span class="p">{},</span>
            <span class="sh">'</span><span class="s">config</span><span class="sh">'</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">config_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">加载配置</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">execution_context</span><span class="p">[</span><span class="sh">'</span><span class="s">config</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_data</span>
    
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sh">"""</span><span class="s">设置数据</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">execution_context</span><span class="p">[</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    
    <span class="k">def</span> <span class="nf">execute_script</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">script</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">执行脚本</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 创建独立的局部命名空间
</span>            <span class="n">local_context</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># 执行脚本
</span>            <span class="nf">exec</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">execution_context</span><span class="p">,</span> <span class="n">local_context</span><span class="p">)</span>
            
            <span class="c1"># 更新结果
</span>            <span class="k">if</span> <span class="sh">'</span><span class="s">results</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">local_context</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">execution_context</span><span class="p">[</span><span class="sh">'</span><span class="s">results</span><span class="sh">'</span><span class="p">].</span><span class="nf">update</span><span class="p">(</span><span class="n">local_context</span><span class="p">[</span><span class="sh">'</span><span class="s">results</span><span class="sh">'</span><span class="p">])</span>
            
            <span class="k">return</span> <span class="n">local_context</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">脚本执行失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">execute_config_scripts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">执行配置中的脚本</span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># 执行初始化脚本
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">init_script</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">执行初始化脚本...</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">init_result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">execute_script</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">init_script</span><span class="sh">'</span><span class="p">])</span>
            <span class="n">results</span><span class="p">[</span><span class="sh">'</span><span class="s">init</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_result</span>
        
        <span class="c1"># 执行数据处理脚本
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">data_scripts</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="sh">'</span><span class="s">data_processing</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">script</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">data_scripts</span><span class="sh">'</span><span class="p">]):</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">执行数据处理脚本 </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s">...</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">script_result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">execute_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="sh">'</span><span class="s">data_processing</span><span class="sh">'</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">script_result</span><span class="p">)</span>
        
        <span class="c1"># 执行清理脚本
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">cleanup_script</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">执行清理脚本...</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">cleanup_result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">execute_script</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">cleanup_script</span><span class="sh">'</span><span class="p">])</span>
            <span class="n">results</span><span class="p">[</span><span class="sh">'</span><span class="s">cleanup</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleanup_result</span>
        
        <span class="k">return</span> <span class="n">results</span>

<span class="c1"># 测试配置驱动执行
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">配置驱动执行示例:</span><span class="sh">"</span><span class="p">)</span>

<span class="n">executor</span> <span class="o">=</span> <span class="nc">ConfigDrivenExecutor</span><span class="p">()</span>

<span class="c1"># 设置测试数据
</span><span class="n">test_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">numbers</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">names</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="sh">'</span><span class="s">Alice</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Bob</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Charlie</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">David</span><span class="sh">'</span><span class="p">],</span>
    <span class="sh">'</span><span class="s">scores</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">85</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">96</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">executor</span><span class="p">.</span><span class="nf">set_data</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

<span class="c1"># 配置脚本
</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">init_script</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'''</span><span class="s">
# 初始化变量
total_count = 0
processed_items = []
statistics = {}

print(</span><span class="sh">"</span><span class="s">初始化完成</span><span class="sh">"</span><span class="s">)
</span><span class="sh">'''</span><span class="p">,</span>
    
    <span class="sh">'</span><span class="s">data_scripts</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
        <span class="sh">'''</span><span class="s">
# 处理数字数据
numbers = data[</span><span class="sh">'</span><span class="s">numbers</span><span class="sh">'</span><span class="s">]
even_numbers = [n for n in numbers if n % 2 == 0]
odd_numbers = [n for n in numbers if n % 2 == 1]

statistics[</span><span class="sh">'</span><span class="s">even_count</span><span class="sh">'</span><span class="s">] = len(even_numbers)
statistics[</span><span class="sh">'</span><span class="s">odd_count</span><span class="sh">'</span><span class="s">] = len(odd_numbers)
statistics[</span><span class="sh">'</span><span class="s">total_sum</span><span class="sh">'</span><span class="s">] = sum(numbers)
statistics[</span><span class="sh">'</span><span class="s">average</span><span class="sh">'</span><span class="s">] = sum(numbers) / len(numbers)

print(f</span><span class="sh">"</span><span class="s">处理了 {len(numbers)} 个数字</span><span class="sh">"</span><span class="s">)
print(f</span><span class="sh">"</span><span class="s">偶数: {even_numbers}</span><span class="sh">"</span><span class="s">)
print(f</span><span class="sh">"</span><span class="s">奇数: {odd_numbers}</span><span class="sh">"</span><span class="s">)
</span><span class="sh">'''</span><span class="p">,</span>
        
        <span class="sh">'''</span><span class="s">
# 处理名字和分数数据
names = data[</span><span class="sh">'</span><span class="s">names</span><span class="sh">'</span><span class="s">]
scores = data[</span><span class="sh">'</span><span class="s">scores</span><span class="sh">'</span><span class="s">]

# 创建学生记录
students = []
for name, score in zip(names, scores):
    grade = </span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="s"> if score &gt;= 90 else </span><span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="s"> if score &gt;= 80 else </span><span class="sh">'</span><span class="s">C</span><span class="sh">'</span><span class="s">
    students.append({
        </span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="s">: name,
        </span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="s">: score,
        </span><span class="sh">'</span><span class="s">grade</span><span class="sh">'</span><span class="s">: grade
    })

# 统计成绩
grade_counts = {</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="s">: 0, </span><span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="s">: 0, </span><span class="sh">'</span><span class="s">C</span><span class="sh">'</span><span class="s">: 0}
for student in students:
    grade_counts[student[</span><span class="sh">'</span><span class="s">grade</span><span class="sh">'</span><span class="s">]] += 1

statistics[</span><span class="sh">'</span><span class="s">students</span><span class="sh">'</span><span class="s">] = students
statistics[</span><span class="sh">'</span><span class="s">grade_distribution</span><span class="sh">'</span><span class="s">] = grade_counts
statistics[</span><span class="sh">'</span><span class="s">highest_score</span><span class="sh">'</span><span class="s">] = max(scores)
statistics[</span><span class="sh">'</span><span class="s">lowest_score</span><span class="sh">'</span><span class="s">] = min(scores)

print(f</span><span class="sh">"</span><span class="s">处理了 {len(students)} 个学生记录</span><span class="sh">"</span><span class="s">)
for student in students:
    print(f</span><span class="sh">"</span><span class="s">  {student[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="s">]}: {student[</span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="s">]} ({student[</span><span class="sh">'</span><span class="s">grade</span><span class="sh">'</span><span class="s">]})</span><span class="sh">"</span><span class="s">)
</span><span class="sh">'''</span>
    <span class="p">],</span>
    
    <span class="sh">'</span><span class="s">cleanup_script</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'''</span><span class="s">
# 生成最终报告
report = {
    </span><span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="s">: {
        </span><span class="sh">'</span><span class="s">total_numbers</span><span class="sh">'</span><span class="s">: len(data[</span><span class="sh">'</span><span class="s">numbers</span><span class="sh">'</span><span class="s">]),
        </span><span class="sh">'</span><span class="s">total_students</span><span class="sh">'</span><span class="s">: len(data[</span><span class="sh">'</span><span class="s">names</span><span class="sh">'</span><span class="s">]),
        </span><span class="sh">'</span><span class="s">processing_complete</span><span class="sh">'</span><span class="s">: True
    },
    </span><span class="sh">'</span><span class="s">statistics</span><span class="sh">'</span><span class="s">: statistics
}

results[</span><span class="sh">'</span><span class="s">final_report</span><span class="sh">'</span><span class="s">] = report

print(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== 最终报告 ===</span><span class="sh">"</span><span class="s">)
print(f</span><span class="sh">"</span><span class="s">处理数字总数: {report[</span><span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="s">][</span><span class="sh">'</span><span class="s">total_numbers</span><span class="sh">'</span><span class="s">]}</span><span class="sh">"</span><span class="s">)
print(f</span><span class="sh">"</span><span class="s">学生总数: {report[</span><span class="sh">'</span><span class="s">summary</span><span class="sh">'</span><span class="s">][</span><span class="sh">'</span><span class="s">total_students</span><span class="sh">'</span><span class="s">]}</span><span class="sh">"</span><span class="s">)
print(f</span><span class="sh">"</span><span class="s">数字总和: {statistics[</span><span class="sh">'</span><span class="s">total_sum</span><span class="sh">'</span><span class="s">]}</span><span class="sh">"</span><span class="s">)
print(f</span><span class="sh">"</span><span class="s">平均值: {statistics[</span><span class="sh">'</span><span class="s">average</span><span class="sh">'</span><span class="s">]:.2f}</span><span class="sh">"</span><span class="s">)
print(f</span><span class="sh">"</span><span class="s">最高分: {statistics[</span><span class="sh">'</span><span class="s">highest_score</span><span class="sh">'</span><span class="s">]}</span><span class="sh">"</span><span class="s">)
print(f</span><span class="sh">"</span><span class="s">最低分: {statistics[</span><span class="sh">'</span><span class="s">lowest_score</span><span class="sh">'</span><span class="s">]}</span><span class="sh">"</span><span class="s">)
print(f</span><span class="sh">"</span><span class="s">成绩分布: {statistics[</span><span class="sh">'</span><span class="s">grade_distribution</span><span class="sh">'</span><span class="s">]}</span><span class="sh">"</span><span class="s">)
print(</span><span class="sh">"</span><span class="s">处理完成!</span><span class="sh">"</span><span class="s">)
</span><span class="sh">'''</span>
<span class="p">}</span>

<span class="c1"># 执行配置脚本
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">开始执行配置脚本:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">=</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">execution_results</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nf">execute_config_scripts</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">=== 执行结果 ===</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="sh">'</span><span class="s">final_report</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">executor</span><span class="p">.</span><span class="n">execution_context</span><span class="p">[</span><span class="sh">'</span><span class="s">results</span><span class="sh">'</span><span class="p">]:</span>
        <span class="n">final_report</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="n">execution_context</span><span class="p">[</span><span class="sh">'</span><span class="s">results</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">final_report</span><span class="sh">'</span><span class="p">]</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">最终报告已生成</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">统计信息: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">final_report</span><span class="p">[</span><span class="sh">'</span><span class="s">statistics</span><span class="sh">'</span><span class="p">])</span><span class="si">}</span><span class="s"> 项</span><span class="sh">"</span><span class="p">)</span>
    
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">执行失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="-高级应用">🚀 高级应用</h2>

<h3 id="插件系统">插件系统</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">importlib.util</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="n">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>

<span class="c1"># 插件系统实现
</span><span class="k">class</span> <span class="nc">Plugin</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">插件基类</span><span class="sh">"""</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">获取插件名称</span><span class="sh">"""</span>
        <span class="k">pass</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">获取插件版本</span><span class="sh">"""</span>
        <span class="k">pass</span>
    
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">执行插件</span><span class="sh">"""</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">PluginManager</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">插件管理器</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">plugins</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Plugin</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">plugin_code_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># 安全的执行环境
</span>        <span class="n">self</span><span class="p">.</span><span class="n">safe_globals</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="sh">'</span><span class="s">print</span><span class="sh">'</span><span class="p">:</span> <span class="k">print</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">len</span><span class="sh">'</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">range</span><span class="sh">'</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">enumerate</span><span class="sh">'</span><span class="p">:</span> <span class="nb">enumerate</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">zip</span><span class="sh">'</span><span class="p">:</span> <span class="nb">zip</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">:</span> <span class="nb">sum</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">:</span> <span class="nb">max</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">abs</span><span class="sh">'</span><span class="p">:</span> <span class="nb">abs</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">round</span><span class="sh">'</span><span class="p">:</span> <span class="nb">round</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">int</span><span class="sh">'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">float</span><span class="sh">'</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">str</span><span class="sh">'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">bool</span><span class="sh">'</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">list</span><span class="sh">'</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">tuple</span><span class="sh">'</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">dict</span><span class="sh">'</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">set</span><span class="sh">'</span><span class="p">:</span> <span class="nb">set</span>
            <span class="p">},</span>
            <span class="sh">'</span><span class="s">Plugin</span><span class="sh">'</span><span class="p">:</span> <span class="n">Plugin</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">load_plugin_from_code</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">plugin_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plugin_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">从代码加载插件</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 创建插件命名空间
</span>            <span class="n">plugin_namespace</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c1"># 执行插件代码
</span>            <span class="nf">exec</span><span class="p">(</span><span class="n">plugin_code</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">safe_globals</span><span class="p">,</span> <span class="n">plugin_namespace</span><span class="p">)</span>
            
            <span class="c1"># 查找插件类
</span>            <span class="n">plugin_class</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">plugin_namespace</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
                <span class="nf">if </span><span class="p">(</span><span class="nf">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> 
                    <span class="nf">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Plugin</span><span class="p">)</span> <span class="ow">and</span> 
                    <span class="n">obj</span> <span class="o">!=</span> <span class="n">Plugin</span><span class="p">):</span>
                    <span class="n">plugin_class</span> <span class="o">=</span> <span class="n">obj</span>
                    <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">plugin_class</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sh">"</span><span class="s">未找到有效的插件类</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="c1"># 创建插件实例
</span>            <span class="n">plugin_instance</span> <span class="o">=</span> <span class="nf">plugin_class</span><span class="p">()</span>
            
            <span class="c1"># 注册插件
</span>            <span class="n">self</span><span class="p">.</span><span class="n">plugins</span><span class="p">[</span><span class="n">plugin_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">plugin_instance</span>
            <span class="n">self</span><span class="p">.</span><span class="n">plugin_code_cache</span><span class="p">[</span><span class="n">plugin_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">plugin_code</span>
            
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">插件 </span><span class="sh">'</span><span class="si">{</span><span class="n">plugin_name</span><span class="si">}</span><span class="sh">'</span><span class="s"> 加载成功</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  名称: </span><span class="si">{</span><span class="n">plugin_instance</span><span class="p">.</span><span class="nf">get_name</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  版本: </span><span class="si">{</span><span class="n">plugin_instance</span><span class="p">.</span><span class="nf">get_version</span><span class="p">()</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="bp">True</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">加载插件 </span><span class="sh">'</span><span class="si">{</span><span class="n">plugin_name</span><span class="si">}</span><span class="sh">'</span><span class="s"> 失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">execute_plugin</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">plugin_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">执行插件</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">plugin_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">plugins</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">插件 </span><span class="sh">'</span><span class="si">{</span><span class="n">plugin_name</span><span class="si">}</span><span class="sh">'</span><span class="s"> 未找到</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="n">plugin</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">plugins</span><span class="p">[</span><span class="n">plugin_name</span><span class="p">]</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">context</span> <span class="ow">or</span> <span class="p">{}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plugin</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">执行插件 </span><span class="sh">'</span><span class="si">{</span><span class="n">plugin_name</span><span class="si">}</span><span class="sh">'</span><span class="s"> 失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">list_plugins</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="sh">"""</span><span class="s">列出所有插件</span><span class="sh">"""</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">plugins</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">plugin_list</span><span class="p">.</span><span class="nf">append</span><span class="p">({</span>
                <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="sh">'</span><span class="s">plugin_name</span><span class="sh">'</span><span class="p">:</span> <span class="n">plugin</span><span class="p">.</span><span class="nf">get_name</span><span class="p">(),</span>
                <span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">:</span> <span class="n">plugin</span><span class="p">.</span><span class="nf">get_version</span><span class="p">()</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">plugin_list</span>
    
    <span class="k">def</span> <span class="nf">unload_plugin</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">plugin_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">卸载插件</span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">plugin_name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">plugins</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">plugins</span><span class="p">[</span><span class="n">plugin_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">plugin_name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">plugin_code_cache</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">self</span><span class="p">.</span><span class="n">plugin_code_cache</span><span class="p">[</span><span class="n">plugin_name</span><span class="p">]</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">插件 </span><span class="sh">'</span><span class="si">{</span><span class="n">plugin_name</span><span class="si">}</span><span class="sh">'</span><span class="s"> 已卸载</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c1"># 测试插件系统
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">插件系统示例:</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plugin_manager</span> <span class="o">=</span> <span class="nc">PluginManager</span><span class="p">()</span>

<span class="c1"># 数学计算插件
</span><span class="n">math_plugin_code</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
class MathPlugin(Plugin):
    </span><span class="sh">"""</span><span class="s">数学计算插件</span><span class="sh">"""</span><span class="s">
    
    def get_name(self) -&gt; str:
        return </span><span class="sh">"</span><span class="s">数学计算器</span><span class="sh">"</span><span class="s">
    
    def get_version(self) -&gt; str:
        return </span><span class="sh">"</span><span class="s">1.0.0</span><span class="sh">"</span><span class="s">
    
    def execute(self, context: dict) -&gt; dict:
        numbers = context.get(</span><span class="sh">'</span><span class="s">numbers</span><span class="sh">'</span><span class="s">, [])
        
        if not numbers:
            return {</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">没有提供数字</span><span class="sh">'</span><span class="s">}
        
        results = {
            </span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="s">: len(numbers),
            </span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="s">: sum(numbers),
            </span><span class="sh">'</span><span class="s">average</span><span class="sh">'</span><span class="s">: sum(numbers) / len(numbers),
            </span><span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="s">: min(numbers),
            </span><span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="s">: max(numbers),
            </span><span class="sh">'</span><span class="s">even_count</span><span class="sh">'</span><span class="s">: len([n for n in numbers if n % 2 == 0]),
            </span><span class="sh">'</span><span class="s">odd_count</span><span class="sh">'</span><span class="s">: len([n for n in numbers if n % 2 == 1])
        }
        
        return results
</span><span class="sh">'''</span>

<span class="c1"># 文本处理插件
</span><span class="n">text_plugin_code</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
class TextPlugin(Plugin):
    </span><span class="sh">"""</span><span class="s">文本处理插件</span><span class="sh">"""</span><span class="s">
    
    def get_name(self) -&gt; str:
        return </span><span class="sh">"</span><span class="s">文本处理器</span><span class="sh">"</span><span class="s">
    
    def get_version(self) -&gt; str:
        return </span><span class="sh">"</span><span class="s">1.1.0</span><span class="sh">"</span><span class="s">
    
    def execute(self, context: dict) -&gt; dict:
        text = context.get(</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="s">, </span><span class="sh">''</span><span class="s">)
        
        if not text:
            return {</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">没有提供文本</span><span class="sh">'</span><span class="s">}
        
        words = text.split()
        
        results = {
            </span><span class="sh">'</span><span class="s">original_text</span><span class="sh">'</span><span class="s">: text,
            </span><span class="sh">'</span><span class="s">character_count</span><span class="sh">'</span><span class="s">: len(text),
            </span><span class="sh">'</span><span class="s">word_count</span><span class="sh">'</span><span class="s">: len(words),
            </span><span class="sh">'</span><span class="s">line_count</span><span class="sh">'</span><span class="s">: text.count(</span><span class="sh">'</span><span class="se">\\</span><span class="s">n</span><span class="sh">'</span><span class="s">) + 1,
            </span><span class="sh">'</span><span class="s">uppercase</span><span class="sh">'</span><span class="s">: text.upper(),
            </span><span class="sh">'</span><span class="s">lowercase</span><span class="sh">'</span><span class="s">: text.lower(),
            </span><span class="sh">'</span><span class="s">title_case</span><span class="sh">'</span><span class="s">: text.title(),
            </span><span class="sh">'</span><span class="s">word_frequency</span><span class="sh">'</span><span class="s">: {}
        }
        
        # 计算词频
        for word in words:
            clean_word = word.lower().strip(</span><span class="sh">'</span><span class="s">.,!?;:</span><span class="sh">'</span><span class="s">)
            if clean_word:
                results[</span><span class="sh">'</span><span class="s">word_frequency</span><span class="sh">'</span><span class="s">][clean_word] = results[</span><span class="sh">'</span><span class="s">word_frequency</span><span class="sh">'</span><span class="s">].get(clean_word, 0) + 1
        
        return results
</span><span class="sh">'''</span>

<span class="c1"># 数据分析插件
</span><span class="n">data_plugin_code</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
class DataAnalysisPlugin(Plugin):
    </span><span class="sh">"""</span><span class="s">数据分析插件</span><span class="sh">"""</span><span class="s">
    
    def get_name(self) -&gt; str:
        return </span><span class="sh">"</span><span class="s">数据分析器</span><span class="sh">"</span><span class="s">
    
    def get_version(self) -&gt; str:
        return </span><span class="sh">"</span><span class="s">2.0.0</span><span class="sh">"</span><span class="s">
    
    def execute(self, context: dict) -&gt; dict:
        data = context.get(</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="s">, [])
        
        if not data:
            return {</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="s">: </span><span class="sh">'</span><span class="s">没有提供数据</span><span class="sh">'</span><span class="s">}
        
        # 分析不同类型的数据
        analysis = {
            </span><span class="sh">'</span><span class="s">total_items</span><span class="sh">'</span><span class="s">: len(data),
            </span><span class="sh">'</span><span class="s">data_types</span><span class="sh">'</span><span class="s">: {},
            </span><span class="sh">'</span><span class="s">numeric_analysis</span><span class="sh">'</span><span class="s">: {},
            </span><span class="sh">'</span><span class="s">string_analysis</span><span class="sh">'</span><span class="s">: {},
            </span><span class="sh">'</span><span class="s">list_analysis</span><span class="sh">'</span><span class="s">: {}
        }
        
        # 统计数据类型
        for item in data:
            item_type = type(item).__name__
            analysis[</span><span class="sh">'</span><span class="s">data_types</span><span class="sh">'</span><span class="s">][item_type] = analysis[</span><span class="sh">'</span><span class="s">data_types</span><span class="sh">'</span><span class="s">].get(item_type, 0) + 1
        
        # 数值分析
        numeric_data = [item for item in data if isinstance(item, (int, float))]
        if numeric_data:
            analysis[</span><span class="sh">'</span><span class="s">numeric_analysis</span><span class="sh">'</span><span class="s">] = {
                </span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="s">: len(numeric_data),
                </span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="s">: sum(numeric_data),
                </span><span class="sh">'</span><span class="s">average</span><span class="sh">'</span><span class="s">: sum(numeric_data) / len(numeric_data),
                </span><span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="s">: min(numeric_data),
                </span><span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="s">: max(numeric_data)
            }
        
        # 字符串分析
        string_data = [item for item in data if isinstance(item, str)]
        if string_data:
            analysis[</span><span class="sh">'</span><span class="s">string_analysis</span><span class="sh">'</span><span class="s">] = {
                </span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="s">: len(string_data),
                </span><span class="sh">'</span><span class="s">total_length</span><span class="sh">'</span><span class="s">: sum(len(s) for s in string_data),
                </span><span class="sh">'</span><span class="s">average_length</span><span class="sh">'</span><span class="s">: sum(len(s) for s in string_data) / len(string_data),
                </span><span class="sh">'</span><span class="s">longest</span><span class="sh">'</span><span class="s">: max(string_data, key=len),
                </span><span class="sh">'</span><span class="s">shortest</span><span class="sh">'</span><span class="s">: min(string_data, key=len)
            }
        
        # 列表分析
        list_data = [item for item in data if isinstance(item, list)]
        if list_data:
            analysis[</span><span class="sh">'</span><span class="s">list_analysis</span><span class="sh">'</span><span class="s">] = {
                </span><span class="sh">'</span><span class="s">count</span><span class="sh">'</span><span class="s">: len(list_data),
                </span><span class="sh">'</span><span class="s">total_elements</span><span class="sh">'</span><span class="s">: sum(len(lst) for lst in list_data),
                </span><span class="sh">'</span><span class="s">average_length</span><span class="sh">'</span><span class="s">: sum(len(lst) for lst in list_data) / len(list_data)
            }
        
        return analysis
</span><span class="sh">'''</span>

<span class="c1"># 加载插件
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">加载插件:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plugin_manager</span><span class="p">.</span><span class="nf">load_plugin_from_code</span><span class="p">(</span><span class="sh">'</span><span class="s">math</span><span class="sh">'</span><span class="p">,</span> <span class="n">math_plugin_code</span><span class="p">)</span>
<span class="n">plugin_manager</span><span class="p">.</span><span class="nf">load_plugin_from_code</span><span class="p">(</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">,</span> <span class="n">text_plugin_code</span><span class="p">)</span>
<span class="n">plugin_manager</span><span class="p">.</span><span class="nf">load_plugin_from_code</span><span class="p">(</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">,</span> <span class="n">data_plugin_code</span><span class="p">)</span>

<span class="c1"># 列出插件
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">已加载的插件:</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">plugin_info</span> <span class="ow">in</span> <span class="n">plugin_manager</span><span class="p">.</span><span class="nf">list_plugins</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">plugin_info</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">plugin_info</span><span class="p">[</span><span class="sh">'</span><span class="s">plugin_name</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> v</span><span class="si">{</span><span class="n">plugin_info</span><span class="p">[</span><span class="sh">'</span><span class="s">version</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 测试数学插件
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">测试数学插件:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">math_context</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">numbers</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]}</span>
<span class="n">math_result</span> <span class="o">=</span> <span class="n">plugin_manager</span><span class="p">.</span><span class="nf">execute_plugin</span><span class="p">(</span><span class="sh">'</span><span class="s">math</span><span class="sh">'</span><span class="p">,</span> <span class="n">math_context</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">数学计算结果: </span><span class="si">{</span><span class="n">math_result</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 测试文本插件
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">测试文本插件:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">text_context</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Hello World! This is a test text. Hello again!</span><span class="sh">'</span><span class="p">}</span>
<span class="n">text_result</span> <span class="o">=</span> <span class="n">plugin_manager</span><span class="p">.</span><span class="nf">execute_plugin</span><span class="p">(</span><span class="sh">'</span><span class="s">text</span><span class="sh">'</span><span class="p">,</span> <span class="n">text_context</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">文本处理结果:</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">text_result</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="sh">'</span><span class="s">word_frequency</span><span class="sh">'</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  词频统计: </span><span class="si">{</span><span class="n">text_result</span><span class="p">[</span><span class="sh">'</span><span class="s">word_frequency</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 测试数据分析插件
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">测试数据分析插件:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">data_context</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="sh">'</span><span class="s">hello</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">world</span><span class="sh">'</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="mf">4.5</span><span class="p">,</span> <span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
<span class="p">}</span>
<span class="n">data_result</span> <span class="o">=</span> <span class="n">plugin_manager</span><span class="p">.</span><span class="nf">execute_plugin</span><span class="p">(</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">,</span> <span class="n">data_context</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">数据分析结果:</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data_result</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="模板引擎">模板引擎</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">re</span>
<span class="kn">from</span> <span class="n">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="c1"># 简单的模板引擎
</span><span class="k">class</span> <span class="nc">TemplateEngine</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">简单的模板引擎</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># 模板语法模式
</span>        
        <span class="n">self</span><span class="p">.</span><span class="n">variable_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\{\{\s*([^}]+)\s*\}\}</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">code_block_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\{%\s*([^%]+)\s*%\}</span><span class="sh">'</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">comment_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">\{#\s*([^#]*)\s*#\}</span><span class="sh">'</span><span class="p">)</span>
        
        
        <span class="c1"># 安全的执行环境
</span>        <span class="n">self</span><span class="p">.</span><span class="n">safe_builtins</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">len</span><span class="sh">'</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">range</span><span class="sh">'</span><span class="p">:</span> <span class="nb">range</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">enumerate</span><span class="sh">'</span><span class="p">:</span> <span class="nb">enumerate</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">zip</span><span class="sh">'</span><span class="p">:</span> <span class="nb">zip</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">:</span> <span class="nb">sum</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">:</span> <span class="nb">max</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">abs</span><span class="sh">'</span><span class="p">:</span> <span class="nb">abs</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">round</span><span class="sh">'</span><span class="p">:</span> <span class="nb">round</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">int</span><span class="sh">'</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">float</span><span class="sh">'</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">str</span><span class="sh">'</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">bool</span><span class="sh">'</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">list</span><span class="sh">'</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">tuple</span><span class="sh">'</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">dict</span><span class="sh">'</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">set</span><span class="sh">'</span><span class="p">:</span> <span class="nb">set</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">sorted</span><span class="sh">'</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">reversed</span><span class="sh">'</span><span class="p">:</span> <span class="nb">reversed</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">render_template</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">渲染模板</span><span class="sh">"""</span>
        <span class="c1"># 移除注释
</span>        <span class="n">template</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">comment_pattern</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        
        <span class="c1"># 处理代码块
</span>        <span class="n">template</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_process_code_blocks</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="c1"># 处理变量
</span>        <span class="n">template</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_process_variables</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">template</span>
    
    <span class="k">def</span> <span class="nf">_process_variables</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">处理变量替换</span><span class="sh">"""</span>
        <span class="k">def</span> <span class="nf">replace_variable</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
            <span class="n">var_expr</span> <span class="o">=</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># 创建安全的执行环境
</span>                <span class="n">safe_context</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">safe_builtins</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">context</span>
                <span class="p">}</span>
                
                <span class="c1"># 求值变量表达式
</span>                <span class="n">result</span> <span class="o">=</span> <span class="nf">eval</span><span class="p">(</span><span class="n">var_expr</span><span class="p">,</span> <span class="n">safe_context</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">return</span> <span class="nf">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="s">{{{{ ERROR: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s"> }}}}</span><span class="sh">"</span>
        
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">variable_pattern</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="n">replace_variable</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_process_code_blocks</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">处理代码块</span><span class="sh">"""</span>
        <span class="k">def</span> <span class="nf">replace_code_block</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="k">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># 创建输出缓冲区
</span>                <span class="n">output_buffer</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="c1"># 创建安全的执行环境
</span>                <span class="n">safe_context</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">safe_builtins</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">output</span><span class="sh">'</span><span class="p">:</span> <span class="n">output_buffer</span><span class="p">,</span>
                    <span class="sh">'</span><span class="s">print_to_template</span><span class="sh">'</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">output_buffer</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)),</span>
                    <span class="o">**</span><span class="n">context</span>
                <span class="p">}</span>
                
                <span class="c1"># 执行代码块
</span>                <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">safe_context</span><span class="p">,</span> <span class="p">{})</span>
                
                <span class="c1"># 返回输出
</span>                <span class="k">return</span> <span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">)</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="o">%</span> <span class="n">ERROR</span><span class="si">:</span> <span class="si">{</span><span class="n">e</span><span class="si">}</span> <span class="o">%</span><span class="si">}</span><span class="sh">"</span>
        
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">code_block_pattern</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="n">replace_code_block</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">render_file_template</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">template_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">渲染文件模板</span><span class="sh">"""</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">渲染模板文件失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 测试模板引擎
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">模板引擎示例:</span><span class="sh">"</span><span class="p">)</span>

<span class="n">template_engine</span> <span class="o">=</span> <span class="nc">TemplateEngine</span><span class="p">()</span>

<span class="c1"># 简单变量模板
</span><span class="n">simple_template</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
欢迎 !
您的年龄是  岁。
您的分数是 ，等级是 A。
</span><span class="sh">"""</span>

<span class="n">simple_context</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">张三</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">age</span><span class="sh">'</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="p">:</span> <span class="mi">95</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">简单变量模板:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">template_engine</span><span class="p">.</span><span class="nf">render_template</span><span class="p">(</span><span class="n">simple_template</span><span class="p">,</span> <span class="n">simple_context</span><span class="p">))</span>

<span class="c1"># 循环模板
</span>
<span class="n">loop_template</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
学生列表:
{% 
for i, student in enumerate(students):
    grade = </span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="s"> if student[</span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="s">] &gt;= 90 else </span><span class="sh">'</span><span class="s">B</span><span class="sh">'</span><span class="s"> if student[</span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="s">] &gt;= 80 else </span><span class="sh">'</span><span class="s">C</span><span class="sh">'</span><span class="s">
    print_to_template(f</span><span class="sh">"</span><span class="s">{i+1}. {student[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="s">]}: {student[</span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="s">]} ({grade})</span><span class="sh">"</span><span class="s">)
%}

统计信息:
- 总人数: {{ len(students) }}
- 平均分: {{ sum(s[</span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="s">] for s in students) / len(students) }}
- 最高分: {{ max(s[</span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="s">] for s in students) }}
- 最低分: {{ min(s[</span><span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="s">] for s in students) }}
</span><span class="sh">"""</span>

<span class="n">loop_context</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">students</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Alice</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="p">:</span> <span class="mi">95</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Bob</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="p">:</span> <span class="mi">87</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Charlie</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="p">:</span> <span class="mi">92</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">David</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">score</span><span class="sh">'</span><span class="p">:</span> <span class="mi">78</span><span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">循环模板:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">template_engine</span><span class="p">.</span><span class="nf">render_template</span><span class="p">(</span><span class="n">loop_template</span><span class="p">,</span> <span class="n">loop_context</span><span class="p">))</span>

<span class="c1"># 条件模板
</span><span class="n">conditional_template</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
{# 这是注释，不会显示 #}
系统状态报告
==================

{% 
if system_status == </span><span class="sh">'</span><span class="s">healthy</span><span class="sh">'</span><span class="s">:
    print_to_template(</span><span class="sh">"</span><span class="s">✅ 系统运行正常</span><span class="sh">"</span><span class="s">)
    print_to_template(f</span><span class="sh">"</span><span class="s">CPU使用率: {cpu_usage}%</span><span class="sh">"</span><span class="s">)
    print_to_template(f</span><span class="sh">"</span><span class="s">内存使用率: {memory_usage}%</span><span class="sh">"</span><span class="s">)
else:
    print_to_template(</span><span class="sh">"</span><span class="s">❌ 系统异常</span><span class="sh">"</span><span class="s">)
    print_to_template(f</span><span class="sh">"</span><span class="s">错误信息: {error_message}</span><span class="sh">"</span><span class="s">)
%}

服务状态:
{% 
for service, status in services.items():
    icon = </span><span class="sh">'</span><span class="s">🟢</span><span class="sh">'</span><span class="s"> if status == </span><span class="sh">'</span><span class="s">running</span><span class="sh">'</span><span class="s"> else </span><span class="sh">'</span><span class="s">🔴</span><span class="sh">'</span><span class="s">
    print_to_template(f</span><span class="sh">"</span><span class="s">{icon} {service}: {status}</span><span class="sh">"</span><span class="s">)
%}

{% 
if alerts:
    print_to_template(</span><span class="sh">"</span><span class="se">\n</span><span class="s">⚠️ 警告信息:</span><span class="sh">"</span><span class="s">)
    for alert in alerts:
        print_to_template(f</span><span class="sh">"</span><span class="s">- {alert}</span><span class="sh">"</span><span class="s">)
else:
    print_to_template(</span><span class="sh">"</span><span class="se">\n</span><span class="s">✅ 无警告信息</span><span class="sh">"</span><span class="s">)
%}
</span><span class="sh">"""</span>

<span class="n">conditional_context</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">system_status</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">healthy</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">cpu_usage</span><span class="sh">'</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">memory_usage</span><span class="sh">'</span><span class="p">:</span> <span class="mi">67</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">services</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span>
        <span class="sh">'</span><span class="s">web_server</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">running</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">database</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">running</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">cache</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">stopped</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">queue</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">running</span><span class="sh">'</span>
    <span class="p">},</span>
    <span class="sh">'</span><span class="s">alerts</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
        <span class="sh">'</span><span class="s">缓存服务已停止</span><span class="sh">'</span><span class="p">,</span>
        <span class="sh">'</span><span class="s">磁盘空间不足 (85% 已使用)</span><span class="sh">'</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">条件模板:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">template_engine</span><span class="p">.</span><span class="nf">render_template</span><span class="p">(</span><span class="n">conditional_template</span><span class="p">,</span> <span class="n">conditional_context</span><span class="p">))</span>

<span class="c1"># 复杂数据处理模板
</span><span class="n">complex_template</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
HTML报告生成
=============

{% 
# 数据预处理
total_sales = sum(item[</span><span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="s">] for item in sales_data)
average_sale = total_sales / len(sales_data) if sales_data else 0
top_products = sorted(sales_data, key=lambda x: x[</span><span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="s">], reverse=True)[:3]

# 按类别分组
category_sales = {}
for item in sales_data:
    category = item[</span><span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="s">]
    if category not in category_sales:
        category_sales[category] = []
    category_sales[category].append(item)

# 生成报告
print_to_template(f</span><span class="sh">"</span><span class="s">销售总额: ${total_sales:,.2f}</span><span class="sh">"</span><span class="s">)
print_to_template(f</span><span class="sh">"</span><span class="s">平均销售额: ${average_sale:,.2f}</span><span class="sh">"</span><span class="s">)
print_to_template(f</span><span class="sh">"</span><span class="s">交易数量: {len(sales_data)}</span><span class="sh">"</span><span class="s">)
print_to_template(</span><span class="sh">""</span><span class="s">)
print_to_template(</span><span class="sh">"</span><span class="s">前三名产品:</span><span class="sh">"</span><span class="s">)
for i, product in enumerate(top_products, 1):
    print_to_template(f</span><span class="sh">"</span><span class="s">{i}. {product[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="s">]}: ${product[</span><span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="s">]:,.2f}</span><span class="sh">"</span><span class="s">)

print_to_template(</span><span class="sh">""</span><span class="s">)
print_to_template(</span><span class="sh">"</span><span class="s">按类别统计:</span><span class="sh">"</span><span class="s">)
for category, items in category_sales.items():
    category_total = sum(item[</span><span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="s">] for item in items)
    print_to_template(f</span><span class="sh">"</span><span class="s">{category}: ${category_total:,.2f} ({len(items)} 项)</span><span class="sh">"</span><span class="s">)
%}
</span><span class="sh">"""</span>

<span class="n">complex_context</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">sales_data</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">笔记本电脑</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">电子产品</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">:</span> <span class="mf">1299.99</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">手机</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">电子产品</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">:</span> <span class="mf">899.99</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">办公椅</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">家具</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">:</span> <span class="mf">299.99</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">键盘</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">电子产品</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">:</span> <span class="mf">79.99</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">书桌</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">家具</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">:</span> <span class="mf">399.99</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">显示器</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">电子产品</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">:</span> <span class="mf">249.99</span><span class="p">},</span>
        <span class="p">{</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">台灯</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">category</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">家具</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">:</span> <span class="mf">49.99</span><span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">复杂数据处理模板:</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">template_engine</span><span class="p">.</span><span class="nf">render_template</span><span class="p">(</span><span class="n">complex_template</span><span class="p">,</span> <span class="n">complex_context</span><span class="p">))</span>

</code></pre></div></div>

<h2 id="️-常见陷阱与最佳实践">⚠️ 常见陷阱与最佳实践</h2>

<h3 id="安全风险防护">安全风险防护</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 安全风险防护示例
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">安全风险防护示例:</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 安全的exec包装器
</span><span class="k">class</span> <span class="nc">SecureExecutor</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s">安全的代码执行器</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="c1"># 危险关键词
</span>        <span class="n">self</span><span class="p">.</span><span class="n">dangerous_keywords</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">import</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">exec</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">eval</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">compile</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">open</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">file</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">__import__</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">__globals__</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">__locals__</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">globals</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">locals</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">vars</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dir</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">hasattr</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">getattr</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">setattr</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">delattr</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">input</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">raw_input</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">reload</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="c1"># 危险模块
</span>        <span class="n">self</span><span class="p">.</span><span class="n">dangerous_modules</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">os</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sys</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">subprocess</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shutil</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">tempfile</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">pickle</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">marshal</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">shelve</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dbm</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sqlite3</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">socket</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">urllib</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">http</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ftplib</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">smtplib</span><span class="sh">'</span>
        <span class="p">}</span>
        
        <span class="c1"># 安全的内置函数
</span>        <span class="n">self</span><span class="p">.</span><span class="n">safe_builtins</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">abs</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">all</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">any</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">bin</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">bool</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">chr</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">dict</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">enumerate</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">filter</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">float</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">hex</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">int</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">len</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">list</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">map</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">min</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">oct</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">ord</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">range</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">reversed</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">round</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">set</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sorted</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">str</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">tuple</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">zip</span><span class="sh">'</span>
        <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">is_safe_code</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">检查代码是否安全</span><span class="sh">"""</span>
        <span class="c1"># 检查危险关键词
</span>        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">dangerous_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">包含危险关键词: </span><span class="si">{</span><span class="n">keyword</span><span class="si">}</span><span class="sh">"</span>
        
        <span class="c1"># 检查危险模块
</span>        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">dangerous_modules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="sa">f</span><span class="sh">"</span><span class="s">尝试访问危险模块: </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="sh">"</span>
        
        <span class="c1"># 检查双下划线属性
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">__</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">包含双下划线属性访问</span><span class="sh">"</span>
        
        <span class="c1"># 检查点号访问（可能的属性访问）
</span>        <span class="k">if</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">code</span> <span class="ow">and</span> <span class="nf">any</span><span class="p">(</span><span class="n">dangerous</span> <span class="ow">in</span> <span class="n">code</span> <span class="k">for</span> <span class="n">dangerous</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">class</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">base</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">subclass</span><span class="sh">'</span><span class="p">]):</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="sh">"</span><span class="s">可能的危险属性访问</span><span class="sh">"</span>
        
        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="sh">"</span><span class="s">代码安全</span><span class="sh">"</span>
    
    <span class="k">def</span> <span class="nf">create_safe_environment</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">allowed_vars</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">创建安全的执行环境</span><span class="sh">"""</span>
        <span class="c1"># 创建受限的内置函数字典
</span>        <span class="n">restricted_builtins</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">safe_builtins</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">__builtins__</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">restricted_builtins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">__builtins__</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        
        <span class="c1"># 基础环境
</span>        <span class="n">safe_env</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="p">:</span> <span class="n">restricted_builtins</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">__name__</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">__restricted__</span><span class="sh">'</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">__doc__</span><span class="sh">'</span><span class="p">:</span> <span class="bp">None</span>
        <span class="p">}</span>
        
        <span class="c1"># 添加允许的变量
</span>        <span class="k">if</span> <span class="n">allowed_vars</span><span class="p">:</span>
            <span class="n">safe_env</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">allowed_vars</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">safe_env</span>
    
    <span class="k">def</span> <span class="nf">safe_exec</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allowed_vars</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">安全地执行代码</span><span class="sh">"""</span>
        <span class="c1"># 检查代码安全性
</span>        <span class="n">is_safe</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_safe_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_safe</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">SecurityError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">不安全的代码: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
        <span class="c1"># 创建安全环境
</span>        <span class="n">safe_globals</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_safe_environment</span><span class="p">(</span><span class="n">allowed_vars</span><span class="p">)</span>
        <span class="n">safe_locals</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 执行代码
</span>            <span class="nf">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">safe_globals</span><span class="p">,</span> <span class="n">safe_locals</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">safe_locals</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">代码执行失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 自定义安全异常
</span><span class="k">class</span> <span class="nc">SecurityError</span><span class="p">(</span><span class="nb">Exception</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">安全异常</span><span class="sh">"""</span>
    <span class="k">pass</span>

<span class="c1"># 测试安全执行器
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">安全执行器测试:</span><span class="sh">"</span><span class="p">)</span>

<span class="n">secure_executor</span> <span class="o">=</span> <span class="nc">SecureExecutor</span><span class="p">()</span>

<span class="c1"># 安全代码测试
</span><span class="n">safe_codes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">x = 10</span><span class="se">\n</span><span class="s">y = 20</span><span class="se">\n</span><span class="s">result = x + y</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">numbers = [1, 2, 3, 4, 5]</span><span class="se">\n</span><span class="s">total = sum(numbers)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">text = </span><span class="sh">'</span><span class="s">Hello World</span><span class="sh">'</span><span class="se">\n</span><span class="s">length = len(text)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">data = [1, 2, 3]</span><span class="se">\n</span><span class="s">filtered = list(filter(lambda x: x &gt; 1, data))</span><span class="sh">"</span>
<span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">安全代码测试:</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">safe_codes</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">secure_executor</span><span class="p">.</span><span class="nf">safe_exec</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  测试 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">: 成功</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">    变量: </span><span class="si">{</span><span class="nf">list</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="nf">keys</span><span class="p">())</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  测试 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">: 失败 - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 危险代码测试
</span><span class="n">dangerous_codes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">import os</span><span class="se">\n</span><span class="s">os.system(</span><span class="sh">'</span><span class="s">ls</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">exec(</span><span class="sh">'</span><span class="s">print(</span><span class="se">\"</span><span class="s">hello</span><span class="se">\"</span><span class="s">)</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">open(</span><span class="sh">'</span><span class="s">/etc/passwd</span><span class="sh">'</span><span class="s">).read()</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">__import__(</span><span class="sh">'</span><span class="s">subprocess</span><span class="sh">'</span><span class="s">).call([</span><span class="sh">'</span><span class="s">ls</span><span class="sh">'</span><span class="s">])</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">[].append.__globals__[</span><span class="sh">'</span><span class="s">__builtins__</span><span class="sh">'</span><span class="s">][</span><span class="sh">'</span><span class="s">eval</span><span class="sh">'</span><span class="s">](</span><span class="sh">'</span><span class="s">1+1</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">().__class__.__bases__[0].__subclasses__()</span><span class="sh">"</span>
<span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">危险代码测试:</span><span class="sh">"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">dangerous_codes</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">secure_executor</span><span class="p">.</span><span class="nf">safe_exec</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  测试 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">: 成功（不应该成功!）</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SecurityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  测试 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">: 被安全机制阻止 - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  测试 </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">: 其他错误 - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 资源限制
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">资源限制示例:</span><span class="sh">"</span><span class="p">)</span>

<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="k">class</span> <span class="nc">ResourceLimitedExecutor</span><span class="p">(</span><span class="n">SecureExecutor</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">资源受限的执行器</span><span class="sh">"""</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">max_memory</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">):</span>  <span class="c1"># 100MB
</span>        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_memory</span> <span class="o">=</span> <span class="n">max_memory</span>
    
    <span class="k">def</span> <span class="nf">timeout_handler</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">超时处理器</span><span class="sh">"""</span>
        <span class="k">raise</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">代码执行超时 (</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">timeout</span><span class="si">}</span><span class="s">秒)</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">safe_exec_with_limits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allowed_vars</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sh">"""</span><span class="s">带资源限制的安全执行</span><span class="sh">"""</span>
        <span class="c1"># 设置超时
</span>        <span class="n">old_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="p">.</span><span class="nf">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">timeout_handler</span><span class="p">)</span>
        <span class="n">signal</span><span class="p">.</span><span class="nf">alarm</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">timeout</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 记录开始时间
</span>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            
            <span class="c1"># 执行代码
</span>            <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">safe_exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">allowed_vars</span><span class="p">)</span>
            
            <span class="c1"># 记录执行时间
</span>            <span class="n">execution_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">result</span><span class="p">[</span><span class="sh">'</span><span class="s">__execution_time__</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">execution_time</span>
            
            <span class="k">return</span> <span class="n">result</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># 恢复信号处理器
</span>            <span class="n">signal</span><span class="p">.</span><span class="nf">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">signal</span><span class="p">.</span><span class="nf">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">old_handler</span><span class="p">)</span>

<span class="c1"># 测试资源限制（在支持信号的系统上）
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">limited_executor</span> <span class="o">=</span> <span class="nc">ResourceLimitedExecutor</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># 正常代码
</span>    <span class="n">normal_code</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
result = 0
for i in range(1000):
    result += i
</span><span class="sh">"""</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">正常代码执行:</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">limited_executor</span><span class="p">.</span><span class="nf">safe_exec_with_limits</span><span class="p">(</span><span class="n">normal_code</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  执行时间: </span><span class="si">{</span><span class="n">result</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">__execution_time__</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">秒</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">  结果: </span><span class="si">{</span><span class="n">result</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">result</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">N/A</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="c1"># 可能超时的代码（注释掉以避免实际超时）
</span>    <span class="c1"># timeout_code = """
</span>    <span class="c1"># import time
</span>    <span class="c1"># time.sleep(10)  # 这会超时
</span>    <span class="c1"># """
</span>    <span class="c1"># 
</span>    <span class="c1"># print("\n超时代码测试:")
</span>    <span class="c1"># try:
</span>    <span class="c1">#     result = limited_executor.safe_exec_with_limits(timeout_code)
</span>    <span class="c1"># except TimeoutError as e:
</span>    <span class="c1">#     print(f"  超时被捕获: {e}")
</span>    
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">资源限制测试跳过（可能不支持信号）: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="-相关函数和模块">📚 相关函数和模块</h2>

<h3 id="内置函数">内置函数</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">eval()</code> - 执行Python表达式</li>
  <li><code class="language-plaintext highlighter-rouge">compile()</code> - 编译Python代码</li>
  <li><code class="language-plaintext highlighter-rouge">globals()</code> - 获取全局命名空间</li>
  <li><code class="language-plaintext highlighter-rouge">locals()</code> - 获取局部命名空间</li>
  <li><code class="language-plaintext highlighter-rouge">vars()</code> - 获取对象的属性字典</li>
  <li><code class="language-plaintext highlighter-rouge">dir()</code> - 列出对象的属性</li>
  <li><code class="language-plaintext highlighter-rouge">hasattr()</code> - 检查属性是否存在</li>
  <li><code class="language-plaintext highlighter-rouge">getattr()</code> - 获取属性值</li>
  <li><code class="language-plaintext highlighter-rouge">setattr()</code> - 设置属性值</li>
  <li><code class="language-plaintext highlighter-rouge">delattr()</code> - 删除属性</li>
</ul>

<h3 id="标准库模块">标准库模块</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">ast</code> - 抽象语法树</li>
  <li><code class="language-plaintext highlighter-rouge">code</code> - 交互式解释器</li>
  <li><code class="language-plaintext highlighter-rouge">codeop</code> - 编译Python代码</li>
  <li><code class="language-plaintext highlighter-rouge">dis</code> - 字节码反汇编</li>
  <li><code class="language-plaintext highlighter-rouge">inspect</code> - 对象检查</li>
  <li><code class="language-plaintext highlighter-rouge">types</code> - 动态类型创建</li>
  <li><code class="language-plaintext highlighter-rouge">importlib</code> - 导入机制</li>
  <li><code class="language-plaintext highlighter-rouge">runpy</code> - 运行Python模块</li>
  <li><code class="language-plaintext highlighter-rouge">traceback</code> - 异常跟踪</li>
</ul>

<h3 id="第三方库">第三方库</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">RestrictedPython</code> - 受限的Python执行</li>
  <li><code class="language-plaintext highlighter-rouge">asteval</code> - 安全的表达式求值</li>
  <li><code class="language-plaintext highlighter-rouge">PyPy</code> - Python解释器</li>
  <li><code class="language-plaintext highlighter-rouge">Jinja2</code> - 模板引擎</li>
  <li><code class="language-plaintext highlighter-rouge">Mako</code> - 模板引擎</li>
</ul>

<h2 id="-扩展阅读">📖 扩展阅读</h2>

<ol>
  <li><strong>Python官方文档</strong>
    <ul>
      <li><a href="https://docs.python.org/3/library/functions.html#exec">Built-in Functions - exec()</a></li>
      <li><a href="https://docs.python.org/3/reference/datamodel.html#code-objects">Code Objects</a></li>
    </ul>
  </li>
  <li><strong>安全相关</strong>
    <ul>
      <li>Python代码注入攻击防护</li>
      <li>沙箱执行环境设计</li>
      <li>安全编程最佳实践</li>
    </ul>
  </li>
  <li><strong>高级应用</strong>
    <ul>
      <li>动态代码生成技术</li>
      <li>插件系统设计</li>
      <li>模板引擎实现</li>
    </ul>
  </li>
</ol>

<h2 id="️-标签">🏷️ 标签</h2>

<p><code class="language-plaintext highlighter-rouge">代码执行</code> <code class="language-plaintext highlighter-rouge">动态执行</code> <code class="language-plaintext highlighter-rouge">语句执行</code> <code class="language-plaintext highlighter-rouge">安全风险</code> <code class="language-plaintext highlighter-rouge">插件系统</code> <code class="language-plaintext highlighter-rouge">模板引擎</code> <code class="language-plaintext highlighter-rouge">代码生成</code> <code class="language-plaintext highlighter-rouge">沙箱执行</code> <code class="language-plaintext highlighter-rouge">资源限制</code> <code class="language-plaintext highlighter-rouge">安全编程</code></p>

      </div>
      
      <!-- 文档底部 -->
      <footer class="doc-footer">
        
        <p class="doc-author">作者: Python文档工程师</p>
        
        
        
        <p class="doc-version">版本: 1.0</p>
        
      </footer>
    </article>
  </main>
  
  <!-- 右侧导航栏 -->
  <aside class="doc-sidebar">
    <div class="toc-container">
      <h3>目录</h3>
      <div id="toc"></div>
    </div>
    
    <!-- 相关链接 -->
    <div class="related-links">
      <h3>相关内容</h3>
      <ul>
        
        
      </ul>
    </div>
  </aside>
</div>

<!-- utterances评论系统 -->
<div class="comments-section">
  <h3 class="comments-title">
    <i class="fas fa-comments"></i>
    讨论与反馈
  </h3>
  <div class="comments-description">
    <p>欢迎在下方留言讨论，分享你的学习心得或提出问题。评论基于GitHub Issues，需要GitHub账号。</p>
  </div>
  <div id="utterances-container">
    <script src="https://utteranc.es/client.js"
            repo="username/PythonModelBook"
            issue-term="pathname"
            theme="preferred-color-scheme"
            crossorigin="anonymous"
            async>
    </script>
  </div>
  

</div>

<style>
.doc-container {
  display: flex;
  max-width: 1200px;
  margin: 0 auto;
  gap: 2rem;
}

.doc-content {
  flex: 1;
  min-width: 0;
}

.doc-header {
  border-bottom: 1px solid #e1e4e8;
  padding-bottom: 1rem;
  margin-bottom: 2rem;
}

.doc-title {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
  color: #24292e;
}

.doc-description {
  font-size: 1.2rem;
  color: #586069;
  margin-bottom: 1rem;
}

.doc-meta {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
  font-size: 0.9rem;
  color: #586069;
}

.doc-tags {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.tag {
  background: #f1f8ff;
  color: #0366d6;
  padding: 0.25rem 0.5rem;
  border-radius: 3px;
  font-size: 0.8rem;
}

.doc-body {
  line-height: 1.6;
}

.doc-body h2 {
  border-bottom: 1px solid #e1e4e8;
  padding-bottom: 0.3rem;
  margin-top: 2rem;
  margin-bottom: 1rem;
}

.doc-body pre {
  background: #f6f8fa;
  padding: 1rem;
  border-radius: 6px;
  overflow-x: auto;
}

.doc-body table {
  border-collapse: collapse;
  width: 100%;
  margin: 1rem 0;
}

.doc-body th,
.doc-body td {
  border: 1px solid #d0d7de;
  padding: 0.5rem;
  text-align: left;
}

.doc-body th {
  background: #f6f8fa;
  font-weight: 600;
}

.doc-sidebar {
  width: 300px;
  position: sticky;
  top: 2rem;
  height: fit-content;
}

.toc-container,
.related-links {
  background: #f6f8fa;
  padding: 1rem;
  border-radius: 6px;
  margin-bottom: 1rem;
}

.toc-container h3,
.related-links h3 {
  margin-top: 0;
  margin-bottom: 1rem;
  font-size: 1.1rem;
}

.related-links ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.related-links li {
  margin-bottom: 0.5rem;
}

.related-links a {
  color: #0366d6;
  text-decoration: none;
}

.related-links a:hover {
  text-decoration: underline;
}

.comments-section {
  max-width: 1200px;
  margin: 2rem auto;
  margin-top: 3rem;
  padding: 2rem;
  background: var(--bg-secondary, #f6f8fa);
  border-radius: var(--radius-xl, 12px);
  border: 1px solid var(--border-color, #e1e4e8);
}

.comments-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  color: var(--text-primary, #24292e);
  font-size: 1.25rem;
  font-weight: 600;
}

.comments-title i {
  color: var(--primary-color, #0366d6);
}

.comments-description {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: var(--bg-primary, #ffffff);
  border-radius: var(--radius-lg, 8px);
  border-left: 4px solid var(--primary-color, #0366d6);
}

.comments-description p {
  margin: 0;
  color: var(--text-secondary, #586069);
  font-size: 0.9rem;
  line-height: 1.5;
}

#utterances-container,
#giscus-container {
  margin-top: 1rem;
}

/* 评论系统切换按钮 */
.comment-system-toggle {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  padding: 0.5rem;
  background: var(--bg-primary, #ffffff);
  border-radius: var(--radius-lg, 8px);
  border: 1px solid var(--border-color, #e1e4e8);
}

.comment-toggle-btn {
  flex: 1;
  padding: 0.5rem 1rem;
  background: transparent;
  border: none;
  border-radius: var(--radius-md, 6px);
  color: var(--text-secondary, #586069);
  font-size: 0.85rem;
  cursor: pointer;
  transition: all var(--transition-fast, 0.15s ease);
}

.comment-toggle-btn.active {
  background: var(--primary-color, #0366d6);
  color: var(--text-inverse, #ffffff);
}

.comment-toggle-btn:hover:not(.active) {
  background: var(--bg-secondary, #f6f8fa);
  color: var(--text-primary, #24292e);
}

@media (max-width: 768px) {
  .doc-container {
    flex-direction: column;
  }
  
  .doc-sidebar {
    width: 100%;
    position: static;
  }
}
</style>

<script>
// 生成目录
document.addEventListener('DOMContentLoaded', function() {
  const toc = document.getElementById('toc');
  const headings = document.querySelectorAll('.doc-body h2, .doc-body h3, .doc-body h4');
  
  if (headings.length > 0) {
    const tocList = document.createElement('ul');
    
    headings.forEach(function(heading, index) {
      const id = 'heading-' + index;
      heading.id = id;
      
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#' + id;
      a.textContent = heading.textContent;
      a.className = 'toc-link toc-' + heading.tagName.toLowerCase();
      
      li.appendChild(a);
      tocList.appendChild(li);
    });
    
    toc.appendChild(tocList);
  }
});

// 评论系统切换功能
function switchCommentSystem(system) {
  const utterancesContainer = document.getElementById('utterances-container');
  const giscusContainer = document.getElementById('giscus-container');
  
  if (system === 'giscus') {
    utterancesContainer.style.display = 'none';
    giscusContainer.style.display = 'block';
  } else {
    utterancesContainer.style.display = 'block';
    giscusContainer.style.display = 'none';
  }
}
</script>
  </main>

  <!-- 返回顶部按钮 -->
  <button id="back-to-top" class="back-to-top" title="返回顶部">
    <i class="fas fa-chevron-up"></i>
  </button>

  <!-- 页脚 -->
  <footer class="footer">
    <div class="footer-container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>Python知识体系文档</h3>
          <p>系统化整理Python知识体系的开源项目</p>
        </div>
        <div class="footer-section">
          <h4>快速链接</h4>
          <ul>
            <li><a href="/PythonModelBook/docs/basics/">基础语法</a></li>
            <li><a href="/PythonModelBook/docs/builtins/">内置函数</a></li>
            <li><a href="/PythonModelBook/docs/stdlib/">标准库</a></li>
            <li><a href="/PythonModelBook/docs/thirdparty/">第三方库</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>社区</h4>
          <ul>
            <li><a href="https://github.com/liberalchang/PythonModelBook" target="_blank">GitHub</a></li>
            <li><a href="/PythonModelBook/CONTRIBUTING/">贡献指南</a></li>
            <li><a href="/PythonModelBook/about/">关于项目</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Python知识体系文档. 采用 <a href="/PythonModelBook/LICENSE">MIT License</a> 开源协议.</p>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="/PythonModelBook/assets/js/main.js"></script>
  <script src="/PythonModelBook/assets/js/search.js"></script>
  
</body>

</html>